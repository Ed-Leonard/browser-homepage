'use client';

import Draggable from 'react-draggable';
import { NodeEntry } from './page';
import { useRef, useState, useEffect } from 'react';
import { createPortal } from "react-dom";

export type AnyProps = Record<string, any>;

export function Clock({ showSeconds = true, use24Hour = false, border = false, background = false }: AnyProps) {
	const [time, setTime] = useState("");

	useEffect(() => {
		const update = () => {
			const now = new Date();

			let hours = now.getHours();
			const minutes = now.getMinutes();
			const seconds = now.getSeconds();

			let suffix = "";

			if (!use24Hour) {
				suffix = hours >= 12 ? " PM" : " AM";
				hours = hours % 12 || 12;
			}

			const hh = hours.toString().padStart(2, "0");
			const mm = minutes.toString().padStart(2, "0");
			const ss = seconds.toString().padStart(2, "0");

			const formatted =
				showSeconds ? `${hh}:${mm}:${ss}${suffix}` : `${hh}:${mm}${suffix}`;

			setTime(formatted);
		};

		update();
		const interval = setInterval(update, 1000);

		return () => clearInterval(interval);
	}, [showSeconds, use24Hour]);

	return (
		<div className={`text-6xl noselect p-2 rounded-lg ${border ? 'border' : 'border-0'} ${background ? 'bg-[#3c3836]' : 'bg-transparent'}`} >
			{time}
		</div >
	);
}

export default function DraggableBox<P extends AnyProps>({ className, node, props, onChange, onClick, z }: NodeEntry<P> & { onClick: () => void }) {
	const nodeRef = useRef(null);
	const Node = node;
	const [showSettings, setShowSettings] = useState(false);

	const toggleFields: Record<string, string> = {
		showSeconds: "Show Seconds",
		use24Hour: "24 Hour",
		border: "Border",
		background: "Background",
	};

	return (
		<>
			<Draggable nodeRef={nodeRef} handle='.header' bounds='parent' onMouseDown={onClick}>
				<div
					ref={nodeRef}
					className={`window group absolute  ${className}`}
					style={{ zIndex: z }} >
					<div
						className='header opacity-0 pb-1 px-1 group-hover:opacity-100 transition-opacity flex justify-between cursor-move'
					>
						<button onClick={() => setShowSettings(!showSettings)} className='cursor-pointer' >settings</button>
						<button className='cursor-pointer'>x</button>
					</div>
					<Node {...props} />
				</div>
			</Draggable>

			{showSettings && createPortal(
				<div
					className='settings absolute top-1/2 left-1/2 p-4 bg-[#1d2021] rounded-lg shadow-lg z-500 text-center flex-col'
					style={{ transform: 'translate(-50%, -50%)' }}
					onMouseDown={e => e.stopPropagation()} // prevent click-through
				>
					{Object.entries(toggleFields).map(([key, label]) =>
						key in props ? (
							<label key={key} className="block cursor-pointer">
								<input
									type="checkbox"
									checked={props[key]}
									onChange={(e) =>
										onChange?.({ [key]: e.target.checked } as any as Partial<P>)
									}
									className="cursor-pointer"
								/>
								{label}
							</label>
						) : null
					)}					<button className="mt-2 px-2 py-1 rounded cursor-pointer" onClick={() => setShowSettings(false)} >Close</button>
				</div>,
				document.body
			)}
		</>
	);
}
